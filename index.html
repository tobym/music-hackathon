<!DOCTYPE html>
<html>


<head>
<meta charset="utf-8">
<link rel="stylesheet" href="style.css" type="text/css" media="screen">
<link rel="stylesheet" href="sp://import/css/adam.css">
<script src="libs/js/jquery.min.js"></script>
<script src="libs/js/mustache.js"></script>

<script type="text/javascript">

  var Game = {
    // User-visible message
    update_message: function(msg) {
      $("#message").html(msg);
      this.log(msg);
    },
    // Debug log
    log: function(msg) {
      $("#debug_log").append("<p>" + msg + "</p>");
    },

    api_host : "http://backend:4567",
    username : "",
    turn_id : "",

    // Displays the given game state.
    displayGamestate : function (state) {
      var $dashboard = $("#game_dashboard");
      var dashboard_tmpl = $("#gamestate_tmpl").html();
      $dashboard.html(Mustache.render(dashboard_tmpl, state));

      var $main = $("#main");
      var main_tmpl = $("#main_tmpl").html();
      $dashboard.html(Mustache.render(main_tmpl, state));
    },

    // Pull latest state and displays it.
    refreshGamestate : function() {
      console.log("refreshing game state...");
      $.get(Game.api_host + "/gamestate", function(data) {
        Game.turn_id = data.turn_id;
        Game.displayGamestate(data);
        console.log("successfully refreshed game state.");
      });
    },

    // Wraps jQuery.post and auto re-syncs game state if it is messed up for some reason.
    post : function(path, data, success) {
      console.log("Inside Game.post");
      data.turn_id = Game.turn_id;
      console.log(data);
      var url = this.api_host + path;
      console.log(url);
      $.ajax({
        type: 'POST',
        url: url,
        data: data,
        success: function(data, textStatus, jqXHR) {
          success(data, textStatus, jqXHR);
          Game.refreshGamestate();
        },
        error: function(jqXHR, textStatus, errorThrown) {
          // FIXME: could use 409 for turn_id conflict, and 400 for other errors like a user submitting twice in one turn.
          if (400 == jqXHR.status) {
            // console.debug(jqXHR);
            // console.debug(textStatus);
            // console.debug(errorThrown);
            // parse responseText
            Game.update_message("Error: " + jqXHR.responseText);
            Game.refreshGamestate();
            // Game.update_message("Woops, had an error. Try that one more time!");
            console.log("got a 400 in the Error callback");
          }
        },
        dataType: "json"
      });
    }
  };

  $(document).ready(function() {
    /* Instantiate the global sp object; include models & views */
    var sp = getSpotifyApi(1);
    var models = sp.require('sp://import/scripts/api/models');
    var views = sp.require('sp://import/scripts/api/views');

    /*
     * Register username and join the (current global) game.
     */
    $("#register_btn").on("click", function() {
      var username = $("#username").val();
      console.log("Registering " + username);
      Game.post("/register", {"username" : username}, function(data) {
        console.log("Register username response: " + data);

        Game.update_message(data.message);
        Game.username = data.username;
        Game.turn_id = data.turn_id;

        // Transition to game state.
        $.get(Game.api_host + "/gamestate", function(data) {
          $("#register").hide();
          $("#current_question").html(data.question.question);
          $("#round").html("Round " + data.round);
          // $("#current_question_keywords").html(data.question.keywords);
          $("#submission").show();
          displayGamestate(data);
        });
      });
    });

    /*
     * Cast your vote.
     */
    $("#submit_btn").on("click", function() {
      var songname = $("#submission_input").val();
      Game.post("/submit_song", {"username" : Game.username, "songname" : songname}, function(data) {
        console.log(data);
      });
    });

    $("#debug").on("click", function() {
      Game.refreshGamestate();
    });

  });

  // initialize game state
  Game.refreshGamestate();

  function win_and_slide() {
    $("#animations").show();

    //animate ninja and player's head
    $('.head, .ninja').show();

    $('.head, .ninja').animate({
      left: '+=200px',
      }, 2000, function() {
      // Animation complete.

    });
    //animate winning text
    $('.win_text').show()

    $('.win_text').animate({
      right: '+=200px',
      }, 2000, function() {
      // Animation complete.
    });
  }

</script>
</head>

<body>
  <div id="debug_log" style="clear:both">
    <h2>Debug Log</h2>
  </div>
  

  <li><a href="sp://music-hackathon/rules.html"> Read the Rules</a></li>

  <button id="debug">Refresh gamestate</button>

  <header>Songville with Friends</header>

  <div id="round">
    1
  </div>

  <div id="message">
    Welcome
  </div>

  <!-- REGISTER -->
  <div id="register">
    <input type="text" id="username" placeholder="Name"/>
    <button id="register_btn">Register</button>
  </div>

  <div id="submission" style="display:none">
    <div id="current_question"></div>
    <div id="current_question_keywords"></div>

    <div>
      <input type="text" id="submission_input" placeholder="Song title..."/>
      <button id="submit_btn">Submit song</button>
    </div>
  </div>

  <div id="game_dashboard">
    <h2>this is the game dashboard</h2>
  </div>


<br/>

<!-- Main begins here -->
<div id="main">
</div> <!-- end of main -->

<div id="animations" style="display:none">
  <div class="win_text">
    <p> Congratulations, you won the round. You have destroyed your opponents, this time. </p>
  </div>

  <div class="head">
    <img src="images/tandy.jpg"/>
  </div>

  <div class="ninja">
    <img src="images/ninja.jpg"/>
  </div>
</div>

<script>


//win_and_slide();
               	               	
</script>

  <script>

    var sp = getSpotifyApi(1);
    var models = sp.require('sp://import/scripts/api/models');

    var search = new models.Search("Bohemian Rhapsody");

    search.observe(models.EVENT.CHANGE, function() {

      search.tracks.forEach(function(track) {
        console.log(track);
      });
    });

    search.appendNext();
  </script>        	

  <script id="main_tmpl" type="text/html">
    <div id="main">
      <div id="your_song">
        {{player_song}}
      </div>

      <div id="song_list">
        <ul>
          {{#submissions}}
          <li class="song_container">
          <span class="songname">{{songname}}</span>
          <div class="play_song">TODO song player here</div>
          <div class="vote"><img src="images/thumb.png"/></div>
          </li>
          {{/submissions}}
        </ul>
      </div>

      <div id="player_list">
        <ul>
          {{#players}}
          <li class="player">
          <div class="avatar">
            <img src="images/tandy.jpg"/>
          </div>
          <p>Name: {{username}}</p>
          <p># of Points</p>
          </li>
          {{/players}}
        </ul>
      </div>

    </div> <!-- end of main -->
  </script>


  <script id="gamestate_tmpl" type="text/html">
    <h2>Game state</h2>
    <h3>Question</h3>
    <p>{{question.question}}</p>
    <h3>Question Keywords</h3>
    <ul>
      {{#question.keywords}}
      <li>{{.}}</li>
      {{/question.keywords}}
    </ul>
    <h3>Round</h3>
    <p>Round {{round}}</p>
    <h3>Players</h3>
    <ul>
      {{#players}}
      <li>{{username}}</li>
      {{/players}}
    </ul>
    <h3>Submissions</h3>
    <ul>
      {{#submissions}}
      <li>{{songname}} :: submitted by {{submitter}}</li>
      {{/submissions}}
    </ul>
  </script>

</body>
</html>
