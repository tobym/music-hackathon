<!DOCTYPE html>
<html>


<head>
<meta charset="utf-8">
<link rel="stylesheet" href="style.css" type="text/css" media="screen">
<link rel="stylesheet" href="sp://import/css/adam.css">
<script src="libs/js/jquery.min.js"></script>
<script src="libs/js/mustache.js"></script>

<script type="text/javascript">

  var Registration = {
    stopAndHide : function() { $("#registration").hide(); },
    startAndShow : function() { $("#registration").show(); }
  };

  var Question = {
    stopAndHide : function() { $("#question").hide(); },
    startAndShow : function() { $("#question").show(); }
  };

  var Preview = {
    stopAndHide : function() { $("#preview").hide(); },
    startAndShow : function() { $("#preview").show(); }
  };

  var Pending = {
    stopAndHide : function() {
      $("#pending").hide();
      // FIXME stop polling for submissions
      if (this.intervalId) {
        clearInterval(this.intervalId);
      }
    },
    startAndShow : function() {
      $("#pending").show();
      // this.intervalId = setInterval(Pending.checkPlayersSubmissions, 1000);
      // FIXME start polling to see if everyone else is done submitting
    },
    checkPlayersSubmissions : function() {
      $.get(Game.api_host + "/gamestate", function(data) {
        // Update X out of Y players have submitted a song
        console.log(data.submissions.length + " out of " + data.players.length + " players have submitted");
        // Transition to next state if all players have submitted.
        if (data.submissions.length === data.players.length) {
          Game.transition("see_submissions"); // this will also clear the polling
        }
      });
    }
  };

  var Voting = {
    stopAndHide : function() {
      $("#voting").hide();
      // FIXME stop polling for votes
    },
    startAndShow : function() {
      $("#voting").show();
      // FIXME start polling to see if everyone else is done voting
    }
  };

  var Winner = {
    stopAndHide : function() { $("#winner").hide(); },
    startAndShow : function() { $("#winner").show(); }
  };

  var Game = {
    // User-visible message
    update_message: function(msg) {
      $("#message").html(msg);
      this.log(msg);
    },
    // Debug log
    log: function(msg) {
      $("#debug_log").append("<p>" + msg + "</p>");
    },

    api_host : "http://backend:4567",
    username : "",
    turn_id : "",
    voted : false, // maintains the state of if this user has voted or not. Used for rendering/not rendering the vote buttons.
    states : ["registration", "question", "preview", "pending", "voting", "winner"],
    state :   "registration", // initial state
    stateControllers : [Registration, Question, Preview, Pending, Voting, Winner],

    init : function() {
      $("button.transition").on("click", function() {
        Game.transition($(this).attr("data-action"));
      });
      Registration.startAndShow();
      Game.refreshGamestate();
    },

    reset : function() {
      Game.voted = false;
      Game.username = "";
      Game.turn_id = "";
      Game.refreshGamestate();
    },

    // Displays the given game state.
    displayGamestate : function (state) {
      // This looks ridiculous, but I want Mustache to render something when the value is false.
      state.not_voted = !Game.voted;

      var dashboard_tmpl = $("#gamestate_tmpl").html();
      $("#game_dashboard").html(Mustache.render(dashboard_tmpl, state));

      var song_list_tmpl = $("#song_list_tmpl").html();
      $("#song_list").html(Mustache.render(song_list_tmpl, state));

      var player_list_tmpl = $("#player_list_tmpl").html();
      $("#player_list").html(Mustache.render(player_list_tmpl, state));
    },

    // Pull latest state and displays it.
    refreshGamestate : function() {
      console.log("refreshing game state...");
      $.get(Game.api_host + "/gamestate", function(data) {
        Game.turn_id = data.turn_id;
        Game.displayGamestate(data);
        console.log("successfully refreshed game state.");
      });
    },

    // Wraps jQuery.post and auto re-syncs game state if it is messed up for some reason.
    post : function(path, data, success) {
      console.log("Inside Game.post");
      data = data || {};
      data.turn_id = Game.turn_id;
      console.log(data);
      var url = this.api_host + path;
      console.log(url);
      $.ajax({
        type: 'POST',
        url: url,
        data: data,
        success: function(data, textStatus, jqXHR) {
          success(data, textStatus, jqXHR);
          Game.refreshGamestate();
        },
        error: function(jqXHR, textStatus, errorThrown) {
          // FIXME: could use 409 for turn_id conflict, and 400 for other errors like a user submitting twice in one turn.
          if (400 === jqXHR.status) {
            // console.debug(jqXHR);
            // console.debug(textStatus);
            // console.debug(errorThrown);
            // parse responseText
            Game.update_message("Error: " + jqXHR.responseText);
            Game.refreshGamestate();
            // Game.update_message("Woops, had an error. Try that one more time!");
            console.log("got a 400 in the Error callback");
          }
        },
        dataType: "json"
      });
    },

    // State machine control.
    transition : function(action) {
                   console.log("Attempting to transition with " + action + " from " + Game.state);

                   // Convenience function.
                   var hideAllStates = function() {
                     $.each(Game.stateControllers, function(idx, val) {
                       val.stopAndHide();
                     });
                   };

                   if ("register" === action && "registration" === Game.state) {
                     Game.refreshGamestate(); // To pull latest player list.
                     $("#opponents").show(); // Show the stuff that was filled in in the background by refreshGamestate

                     hideAllStates();
                     Question.startAndShow();
                     Game.state = "question";
                   } else if ("search" === action && ("question" === Game.state || "preview" === Game.state)) {
                     hideAllStates();
                     Question.startAndShow(); // So you can search again.
                     Preview.startAndShow();  // So you can submit a song.
                     Game.state = "preview";
                   } else if ("submit" === action && "preview" === Game.state) {
                     var songname = $("#submission_input").val();
                     Game.post("/submit_song", {"username" : Game.username, "songname" : songname}, function(data) {
                        hideAllStates();
                        Pending.startAndShow();
                        Game.state = "pending";
                     });
                   } else if ("see_submissions" === action && "pending" === Game.state) {
                     hideAllStates();
                     Voting.startAndShow();
                     Game.state = "voting";
                   } else if ("vote" === action && "voting" === Game.state) {
                     // FIXME wait for automatic transition based on state of other player's votes.
                     hideAllStates();
                     Winner.startAndShow();
                     Game.state = "winner";
                   } else if ("next_round" === action && "winner" === Game.state) {
                     hideAllStates();
                     Question.startAndShow();
                     Game.state = "question";
                   } else {
                     // Illegal transition.
                     Game.log("Illegal transition " + action + " from " + Game.state);
                   }
                   Game.refreshGamestate();
    }
  };

  $(document).ready(function() {

    /* Instantiate the global sp object; include models & views */
    var sp = getSpotifyApi(1);
    var models = sp.require('sp://import/scripts/api/models');
    var views = sp.require('sp://import/scripts/api/views');

    /*
     * Register username and join the (current global) game.
     */
    $("#register_btn").on("click", function() {
      var username = $("#username").val();
      console.log("Registering " + username);
      Game.post("/register", {"username" : username}, function(data) {
        console.log("Register username response: " + data);

        Game.update_message(data.message);
        Game.username = data.username;
        Game.turn_id = data.turn_id;

        // Transition to game state.
        $.get(Game.api_host + "/gamestate", function(data) {
          $("#register").hide();
          $("#current_question").html(data.question.question);
          $("#round").html("Round " + data.round);
          // $("#current_question_keywords").html(data.question.keywords);
          // FIXME this is old; use the new state transition
          $("#submission").show();
          Game.displayGamestate(data);
        });
      });
    });

    /*
     * Cast your vote.
     */
    $("#song_list .vote").live("click", function(ev) {
      ev.preventDefault();
      console.log("clicked on the vote button");
      var songname = $(this).attr("data-songname");
      console.log("voting for " + songname);
      Game.post("/vote_for_song", {"username" : Game.username, "songname" : songname}, function(data) {
        $("#song_list .vote").hide();
        Game.voted = true;
      });
    });

    /*
     * Debug.
     */
    $("#debug").on("click", function() {
      Game.refreshGamestate();
    });


    /*
    * Initialize game state
    */
    Game.init();
  });


  function win_and_slide() {
    $("#animations").show();

    //animate ninja and player's head
    $('.head, .ninja').show();

    $('.head, .ninja').animate({
      left: '+=200px'
      }, 2000, function() {
      // Animation complete.

    });
    //animate winning text
    $('.win_text').show();

    $('.win_text').animate({
      right: '+=200px'
      }, 2000, function() {
      // Animation complete.
    });
  }

</script>
</head>

<body>


  <button id="debug">Refresh gamestate</button>

  <header><img src="images/logo.png"/></header>
  
  <div id="nav">
  	<ul>
  		<li><a href="sp://music-hackathon/index.html"> Play</a></li>
  		<li><a href="sp://music-hackathon/rules.html"> How it works.</a></li>
		</li>
  	</ul>
  </div>




  <div id="round">
    1
  </div>

  <div id="state_container">

    <!-- REGISTER -->
    <div id="registration">
      <div id="welcome_screen">
        <h1 class="intro_title"> What's the best song ______?</h1>
        <p class="intro_copy"> Fight for your honor against other ninjas (AKA your friends) by picking the best song for every situation</p>
      </div> 

      <div id="register_form">
        <input type="text" id="username" placeholder="Enter Your Name"/>
        <button data-action="register" id="register_btn" class="transition">REGISTER</button>
      </div>
    </div>


    <!-- QUESTION and SUBMIT -->
    <div id="question" style="display:none">
      <div id="round_and_question"> 
        <div id="round">
          <img src="images/ninjastar.png"/>
        </div>

        <div id="current_question"></div>
        <div id="current_question_keywords"></div>
      </div>

      <div class="select_song">
        SELECT YOUR SONG: <input type="text" id="submission_input" placeholder="Song title..."/>
        <button data-action="search" id="submit_btn" class="transition"></button>
      </div>
    </div>

    <!-- PREVIEW (the song you just searched for -->
    <div id="preview" style="display:none">
       <div class="preview_round_status">    
       		<div id="round">
       		 <img src="images/ninjastar.png"/>
       		</div>
       		<div id="current_question"></div>
	        <div id="current_question_keywords"></div>
       </div>
       
       <div class="preview_song">
			<div class="preview_song_left">
				<p class="internal_copy">YOUR ENTRY IS IN. AWAITING YOUR OPPONENTS... </p>
				<p class="internal_copy_two">Tip: Obviously you can’t vote for your own song, but your friends can vote for yours 
    			-- so you better have picked one they’d like!</p>
    			
    		</div>
    		
    		<div class="preview_song_right"></div>
    		
       </div>
       
      
      <h2>preview</h2>
      <button data-action="submit" class="transition">SUBMIT</button>
    </div>


    <!-- PENDING (wait until everyone has submitted a song -->
    <div id="pending" style="display:none">
      <h2>pending</h2>
      <button data-action="see_submissions" class="transition">See all the submissions (will be automatic transition)</button>
    </div>


    <!-- VOTING (vote for a song, then wait until everyone else has also voted -->
    <div id="voting" style="display:none">
      <h2>voting</h2>
      <button data-action="vote" class="transition">VOTE</button>
    </div>

    <!-- WINNER (this shows the winner of the round -->
    <div id="winner" style="display:none">
      <h2>winner</h2>
      <button data-action="next_round" class="transition">NEXT ROUND</button>
    </div>


  </div>

  <div id="opponents" class="your_opponents" style="display:none">
    <p>YOUR OPPONENTS:</p>
    <div id="player_list"></div>
  </div>






<br/>


<!-- Main begins here -->
<div id="main">
  <div id="song_list"></div>

</div> <!-- end of main -->

<div id="animations" style="display:none">
  <div class="win_text">
    <p> Congratulations, you won the round. You have destroyed your opponents, this time. </p>
  </div>

  <div class="head">
    <img src="images/tandy.jpg"/>
  </div>

  <div class="ninja">
    <img src="images/ninja.jpg"/>
  </div>
</div>

<script>


//win_and_slide();
               	               	
</script>

  <script>

    var sp = getSpotifyApi(1);
    var models = sp.require('sp://import/scripts/api/models');

    var search = new models.Search("Bohemian Rhapsody");

    search.observe(models.EVENT.CHANGE, function() {

      search.tracks.forEach(function(track) {
        console.log(track);
      });
    });

    search.appendNext();
  </script>        	

  <!-- for development -->
  <div id="game_dashboard">
    <h2>this is the game dashboard</h2>
  </div>


      <!-- <div id="your_song"> -->
        <!-- {{player_song}} -->
      <!-- </div> -->

    <script id="song_list_tmpl" type="text/html">
      <ul>
        {{#submissions}}
        <li class="song_container">
        <span class="songname">{{songname}}</span>
        <div class="play_song">TODO song player here</div>
        {{#not_voted}}
        <a class="vote" data-songname="{{songname}}" href="#">
          vote
          <img src="images/thumb.png"/>
        </a>
        {{/not_voted}}
        </li>
        {{/submissions}}
      </ul>
    </script>

  <script id="player_list_tmpl" type="text/html">
    <ul>
      {{#players}}
      <li class="player">
      <div class="avatar">
        <img src="images/tandy.jpg"/>
      </div>
      <p>Name: {{username}}</p>
      <p># of Points</p>
      </li>
      {{/players}}
    </ul>
  </script>

  <script id="gamestate_tmpl" type="text/html">
    <h2>Game state</h2>
    <h3>Question</h3>
    <p>{{question.question}}</p>
    <h3>Question Keywords</h3>
    <ul>
      {{#question.keywords}}
      <li>{{.}}</li>
      {{/question.keywords}}
    </ul>
    <h3>Round</h3>
    <p>Round {{round}}</p>
    <h3>Not Voted</h3>
    <p>{{not_voted}}</p>
    <h3>Players</h3>
    <ul>
      {{#players}}
      <li>{{username}}</li>
      {{/players}}
    </ul>
    <h3>Submissions</h3>
    <ul>
      {{#submissions}}
      <li>
      <span>{{songname}} :: submitted by {{submitter}}</span>
      <br/>
      votes:
      <ul>
        {{#votes}}
        <li>{{.}}</li>
        {{/votes}}
      </ul>
      -------
      </li>
      {{/submissions}}
    </ul>
  </script>

<div id="debug_log" style="clear:both">
    <h2>Debug Log</h2>
  </div>
  
  <div id="game_dashboard">
    <h2>this is the game dashboard</h2>
  </div>
  
  
  <div id="message">
    		Welcome
    	</div>
  
</body>
</html>
